name: Test Changed Files Only

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/tests/**'
      - 'backend/app/**'
  pull_request:
    branches: [ main ]

jobs:
  test-changed:
    # Always run on push to main (unless commit has [skip-ci])
    if: "!contains(github.event.head_commit.message, '[skip-ci]')"
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: trading_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to see changed files

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install backend dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Get changed test files
        id: changed-files
        run: |
          # Get files changed in this commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep 'backend/tests/.*\.py$' || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "No test files changed"
            echo "test_files=" >> $GITHUB_OUTPUT
          else
            # Convert to space-separated list
            TEST_FILES=$(echo "$CHANGED_FILES" | tr '\n' ' ')
            echo "Changed test files: $TEST_FILES"
            echo "test_files=$TEST_FILES" >> $GITHUB_OUTPUT
          fi

      - name: Run changed tests only
        if: steps.changed-files.outputs.test_files != ''
        timeout-minutes: 20
        env:
          CI: "true"
          DATABASE_URL: postgresql+psycopg://postgres:postgres@localhost:5432/trading_db
          REDIS_URL: redis://localhost:6379/0
          APP_ENV: test
          APP_LOG_LEVEL: INFO
          PYTHONFAULTHANDLER: "1"
        run: |
          python -m pytest ${{ steps.changed-files.outputs.test_files }} \
            --cov=backend/app \
            --cov-report=term-missing \
            --tb=short \
            -v \
            || echo "Tests completed with failures"

      - name: No test files changed
        if: steps.changed-files.outputs.test_files == ''
        run: |
          echo "⚠️ No test files were changed in this commit"
          echo "If you expected tests to run, ensure test files are in backend/tests/"
