name: Code Quality & Security

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python tools
      run: |
        python -m pip install --upgrade pip
        pip install pylint black isort flake8 || echo "Python tools installation failed, continuing..."
    
    - name: Check Python formatting (black)
      run: |
        echo "Checking Python formatting with black..."
        black --check backend/app/ --verbose
    
    - name: Check import sorting (isort)
      run: |
        echo "Checking import sorting with isort..."
        isort --check-only backend/app/ --diff
    
    - name: Lint Python code (pylint)
      run: |
        cd backend
        echo "Running pylint on backend/app..."
        pylint app/ --fail-under=8.0 --exit-zero
        pylint_score=$(pylint app/ --exit-zero | grep -oP "rated at \K[0-9]+\.[0-9]+" || echo "0")
        echo "Pylint score: $pylint_score/10"
    
    - name: Check for security issues (bandit)
      run: |
        pip install bandit
        echo "Running security analysis with bandit..."
        bandit -r backend/app/ -f json -o bandit-report.json --exit-zero
        bandit -r backend/app/ -ll || echo "Bandit check completed"
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Create package-lock.json if not exists
      run: |
        if [ ! -f frontend/package-lock.json ]; then
          cd frontend
          npm install --no-save
        fi
    
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci --legacy-peer-deps || npm install --legacy-peer-deps
    
    - name: Lint TypeScript/JavaScript
      run: |
        cd frontend
        npm run lint || true
    
    - name: Check formatting (Prettier)
      run: |
        cd frontend
        npm run format:check || true
    
    - name: Scan for hardcoded secrets
      run: |
        pip install detect-secrets
        detect-secrets scan --baseline .secrets.baseline || true
    
    - name: Check for TODOs
      run: |
        echo "Checking for TODO comments..."
        todo_count=$(grep -r "TODO\|FIXME\|HACK" backend/app/ frontend/src/ --include="*.py" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" 2>/dev/null | wc -l || echo 0)
        if [ $todo_count -gt 0 ]; then
          echo "⚠️  Found $todo_count TODO/FIXME comments"
          grep -r "TODO\|FIXME\|HACK" backend/app/ frontend/src/ --include="*.py" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" 2>/dev/null || true
        else
          echo "✅ No TODO comments found"
        fi

  dependencies:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Check Python dependencies
      run: |
        echo "Analyzing Python dependencies..."
        python -m pip install --upgrade pip
        if [ -f backend/requirements.txt ]; then
          pip install pip-audit
          echo "Running pip-audit..."
          pip-audit backend/requirements.txt || echo "pip-audit analysis completed"
        fi
    
    - name: Check Python imports
      run: |
        cd backend
        python -m py_compile app/**/*.py || echo "Import check completed"
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Create package-lock.json if needed
      run: |
        if [ ! -f frontend/package-lock.json ]; then
          cd frontend
          npm install --no-save 2>/dev/null || echo "npm install skipped"
        fi
    
    - name: Check npm dependencies
      run: |
        if [ -f frontend/package-lock.json ]; then
          cd frontend
          echo "Running npm audit..."
          npm audit --audit-level=moderate 2>/dev/null || echo "npm audit completed"
        fi
    
    - name: Generate dependency report
      run: |
        echo "Dependency Analysis Report"
        echo "=========================="
        if command -v pip-audit &> /dev/null; then
          echo "Python Dependencies:"
          pip-audit --desc || true
        fi
        if [ -f frontend/package-lock.json ]; then
          echo "Node Dependencies:"
          cd frontend
          npm list --depth=0 || true
        fi
