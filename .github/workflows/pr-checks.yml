name: Pull Request Checks

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

env:
  DATABASE_URL: postgresql://postgres:postgres@localhost:5432/telebot_test
  REDIS_URL: redis://localhost:6379/0
  ENVIRONMENT: test

jobs:
  pr-metadata:
    runs-on: ubuntu-latest
    steps:
      - name: PR Size Check
        run: |
          echo "PR #${{ github.event.pull_request.number }}"
          echo "Changed files: ${{ github.event.pull_request.changed_files }}"
          echo "Additions: ${{ github.event.pull_request.additions }}"
          echo "Deletions: ${{ github.event.pull_request.deletions }}"
          
          if [ ${{ github.event.pull_request.changed_files }} -gt 50 ]; then
            echo "⚠️ Warning: Large PR with ${{ github.event.pull_request.changed_files }} files"
          fi

      - name: Check PR Title Format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ ! "$PR_TITLE" =~ ^(PR-[0-9]+|feat|fix|docs|refactor|test|chore): ]]; then
            echo "❌ PR title must start with PR-XXX: or conventional commit type"
            echo "Example: 'PR-1: Add orchestrator skeleton' or 'feat: Add new feature'"
            exit 1
          fi
          echo "✓ PR title format valid"

  all-checks-passed:
    runs-on: ubuntu-latest
    needs: [pr-metadata]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.pr-metadata.result }}" != "success" ]; then
            echo "❌ Some checks failed"
            exit 1
          fi
          echo "✅ All PR checks passed"
