# PR-019 Bug Fix - Quick Reference

## ONE-LINE FIX

**File**: `backend/app/trading/runtime/heartbeat.py`
**Line**: 226
**Change**: Added `await` keyword

```diff
- metrics = metrics_provider()
+ metrics = await metrics_provider()
```

## Why

- `metrics_provider` is async (documented in docstring)
- Calling without `await` returns coroutine object, not dict
- Code tries to unpack coroutine as `**kwargs` → TypeError
- Fix: add `await` to properly execute async function

## Test Case

```python
async def test_heartbeat_with_async_metrics_provider():
    hb = HeartbeatManager(interval_seconds=0.05)
    call_count = 0

    async def async_metrics():
        nonlocal call_count
        call_count += 1
        return {"signals_processed": call_count, ...}

    task = await hb.start_background_heartbeat(async_metrics)
    await asyncio.sleep(0.15)
    task.cancel()

    assert call_count >= 3  # ✅ Now passes (was 0 before fix)
```

## Impact

- ❌ Before: Heartbeat crashes, no metrics, guards fail
- ✅ After: Heartbeat works, metrics collected, trading proceeds

## Status

✅ FIXED
✅ VERIFIED
✅ DOCUMENTED
⏳ TESTS READY TO IMPLEMENT
