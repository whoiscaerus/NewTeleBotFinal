# CDN Headers Configuration
#
# Purpose: Cache control and security headers for CloudFront/Fastly
# Usage: Apply these headers to CDN distribution for optimal performance and security
#
# ISR (Incremental Static Regeneration): Next.js revalidates pages at intervals
# - Homepage: revalidate every 60 seconds (marketing content)
# - Pricing: revalidate every 300 seconds (pricing changes infrequent)
# - Legal pages: revalidate every 3600 seconds (rarely change)
# - Performance: revalidate every 60 seconds (live stats)


# Global Security Headers (apply to all routes)
security_headers:
  # Prevent clickjacking
  X-Frame-Options: "DENY"

  # XSS protection
  X-Content-Type-Options: "nosniff"
  X-XSS-Protection: "1; mode=block"

  # Referrer policy (balance privacy with analytics)
  Referrer-Policy: "strict-origin-when-cross-origin"

  # Permissions policy (restrict browser features)
  Permissions-Policy: "camera=(), microphone=(), geolocation=(), interest-cohort=()"

  # Content Security Policy (CSP)
  Content-Security-Policy: >
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://telegram.org;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' data: https: blob:;
    connect-src 'self' https://api.telebot-trading.com wss://api.telebot-trading.com;
    frame-src 'self' https://telegram.org;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'none';
    upgrade-insecure-requests;

  # HSTS (force HTTPS for 1 year)
  Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"


# Static Assets (long cache)
static_assets:
  paths:
    - "/_next/static/*"
    - "/icons/*"
    - "/fonts/*"
    - "/images/*"
  headers:
    Cache-Control: "public, max-age=31536000, immutable"
    # 1 year cache for immutable assets (content-hashed filenames)


# Homepage (short cache with ISR)
homepage:
  path: "/"
  headers:
    Cache-Control: "public, s-maxage=60, stale-while-revalidate=120"
    # CDN: cache for 60s, serve stale for 120s while revalidating
    # ISR: Next.js revalidates every 60s
    Vary: "Accept-Encoding, Cookie"
    # Vary on Cookie to handle A/B testing variants


# Pricing Page (medium cache with ISR)
pricing:
  path: "/pricing"
  headers:
    Cache-Control: "public, s-maxage=300, stale-while-revalidate=600"
    # CDN: cache for 5 minutes, serve stale for 10 minutes
    # ISR: revalidate every 5 minutes
    Vary: "Accept-Encoding, Cookie"


# Legal Pages (long cache with ISR)
legal:
  paths:
    - "/legal/terms"
    - "/legal/privacy"
    - "/legal/risk"
    - "/legal/cookies"
  headers:
    Cache-Control: "public, s-maxage=3600, stale-while-revalidate=7200"
    # CDN: cache for 1 hour, serve stale for 2 hours
    # ISR: revalidate every 1 hour
    Vary: "Accept-Encoding"


# Performance Page (short cache - live data)
performance:
  path: "/performance"
  headers:
    Cache-Control: "public, s-maxage=60, stale-while-revalidate=120"
    # CDN: cache for 60s, serve stale for 120s
    # ISR: revalidate every 60s (live stats)
    Vary: "Accept-Encoding"


# API Routes (no cache - dynamic)
api:
  paths:
    - "/api/*"
  headers:
    Cache-Control: "private, no-cache, no-store, must-revalidate"
    Pragma: "no-cache"
    Expires: "0"
    # Never cache API responses (authenticated, user-specific)


# Sitemap & Robots (medium cache)
seo:
  paths:
    - "/sitemap.xml"
    - "/robots.txt"
  headers:
    Cache-Control: "public, s-maxage=3600, stale-while-revalidate=7200"
    Content-Type: "text/xml; charset=utf-8" # sitemap
    # Content-Type: "text/plain; charset=utf-8" # robots.txt


# Image Optimization (Next.js Image API)
images:
  path: "/_next/image*"
  headers:
    Cache-Control: "public, max-age=604800, stale-while-revalidate=2592000"
    # 7 days cache, serve stale for 30 days
    Vary: "Accept"
    # Vary on Accept for WebP/AVIF support


# CloudFront Configuration (example)
# Apply in AWS Console → CloudFront → Behaviors → Custom Headers
cloudfront:
  distribution_id: "E1234ABCD5678"
  behaviors:
    - path_pattern: "/_next/static/*"
      cache_policy: "CachingOptimized"
      origin_request_policy: "CORS-S3Origin"
      compress: true
      viewer_protocol_policy: "redirect-to-https"

    - path_pattern: "/api/*"
      cache_policy: "CachingDisabled"
      origin_request_policy: "AllViewer"
      compress: false
      viewer_protocol_policy: "https-only"
      allowed_methods: ["GET", "HEAD", "OPTIONS", "PUT", "POST", "PATCH", "DELETE"]

    - path_pattern: "/*" # Default behavior
      cache_policy: "CachingOptimizedForUncompressedObjects"
      origin_request_policy: "CORS-CustomOrigin"
      compress: true
      viewer_protocol_policy: "redirect-to-https"
      custom_headers:
        X-Frame-Options: "DENY"
        X-Content-Type-Options: "nosniff"
        Strict-Transport-Security: "max-age=31536000; includeSubDomains"


# Fastly Configuration (example)
# Apply in Fastly Console → Service → VCL Snippets
fastly:
  service_id: "abc123xyz456"
  vcl_snippets:
    - name: "security_headers"
      type: "deliver"
      content: |
        set resp.http.X-Frame-Options = "DENY";
        set resp.http.X-Content-Type-Options = "nosniff";
        set resp.http.Strict-Transport-Security = "max-age=31536000";

    - name: "cache_static"
      type: "recv"
      content: |
        if (req.url ~ "^/_next/static/") {
          set req.http.X-Long-Cache = "true";
        }

    - name: "cache_control_static"
      type: "deliver"
      content: |
        if (req.http.X-Long-Cache == "true") {
          set resp.http.Cache-Control = "public, max-age=31536000, immutable";
        }


# Next.js Configuration (next.config.js)
# Add these headers via Next.js config:
nextjs_headers:
  - source: "/(.*)"
    headers:
      - key: "X-DNS-Prefetch-Control"
        value: "on"
      - key: "X-Frame-Options"
        value: "DENY"
      - key: "X-Content-Type-Options"
        value: "nosniff"
      - key: "Referrer-Policy"
        value: "strict-origin-when-cross-origin"
      - key: "Permissions-Policy"
        value: "camera=(), microphone=(), geolocation=()"

  - source: "/_next/static/(.*)"
    headers:
      - key: "Cache-Control"
        value: "public, max-age=31536000, immutable"


# Performance Targets (measured via Lighthouse/web-vitals)
performance_targets:
  targets:
    # Core Web Vitals (Google ranking factors)
    lcp: "<2.5s"      # Largest Contentful Paint
    fid: "<100ms"     # First Input Delay
    cls: "<0.1"       # Cumulative Layout Shift
    ttfb: "<600ms"    # Time to First Byte

    # Additional metrics
    tti: "<3.8s"      # Time to Interactive
    tbt: "<300ms"     # Total Blocking Time
    speed_index: "<3.4s"

  lighthouse:
    performance: ">90"
    accessibility: ">90"
    best_practices: ">90"
    seo: ">90"
    pwa: ">80"


# ISR Configuration (Next.js revalidation)
# Define in page components:
isr:
  revalidate_intervals:
    homepage: 60        # 1 minute
    pricing: 300        # 5 minutes
    legal: 3600         # 1 hour
    performance: 60     # 1 minute
    blog_posts: 1800    # 30 minutes
    docs: 3600          # 1 hour
